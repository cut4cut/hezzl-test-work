# Тестовое задание на позицию бэкенд-разработчика

## Микросервис для работы с пользователем

**Задача:**

Реализовать gRPC сервис со следующим функционалам: добавить пользователя, удалить пользователя, передать список пользователей.

**Требования:**

1. Описать proto файл с сервисом
2. Реализовать gRPC сервис на основе proto файла на Go  
3. Для хранения данных использовать PostgreSQL  
4. На запрос получения списка пользователей данные будут кешироваться в Redis на минуту и брать из Redis  
5. При добавлении пользователя делать лог в ClickHouse   
6. Добавление логов в ClickHouse делать через очередь Kafka

**Решение:**

Решение удовлетворяет всем выше указанным требованиям. Proto файл находится в папке `internal/controller/rpc/proto/`.  Команда для кодогенерации ручек gRPC сервера на Gо `make protoc`. Описание пользователя находится в `internal/entity/user.go` и `migration/postgres/migration.sql`.

При запуске проекта приложение ожидает 15 секунд пока контейнер с Kafka полностью запустится. После этого происходит поочередное подключение к другим контейнерам в следующем порядке: PostgreSQL, Redis и Kafka. И запуск самого gRPC сервера. Подробнее в папке `internal/app`. 

Для передачи списка пользователей была реализована пагинация по 5 пользователей на страницу с сортировкой по двум полям `name` и `created_dt`. Кэширование списка пользователей происходило по композитному ключу из номера страницы (начиная с 0) и признаков сортировки по убыванию для каждого поля. Подробнее в файле `internal/entity/pagination.go`.

При создании нового пользователя продуцируется сообщение о событии в Kafka. Сообщение о новом пользователе записывается в ClickHouse с помощью родного engine `Kafka`. Подробнее в `migration/clickhouse`.

Пример клиента реализованного gRPC сервиса находится в `client-example`. Пример обеспечивает большую ясность в понимании работы самого сервиса и заодно проводит частичное интеграционное тестирование при запуске после `make down`.

**Развёртывание:**

Запуск проекта с помощью `docker-compose`:
```shell
make run
```

После успешного запуска проекта можно проверить работу с помощью примера из `client-example` и удостоверится в записи логов о создании пользователя в ClickHouse:

```shell
echo 'select * from new_user' | curl 'http://localhost:8123/' --data-binary @-
```

Остановка сервера и СУБД, удаление контейнеров и сети:
```shell
make down
```
